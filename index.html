<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website.io - AI Council Forge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A237E; /* Deep Royal Blue */
            color: #ECEFF1; /* Silver */
        }
        /* Custom Gold Accent */
        .accent-gold {
            color: #FFD700;
        }
        .bg-accent-gold {
            background-color: #FFD700;
        }
        .border-accent-gold {
            border-color: #FFD700;
        }
        /* Styling for file input */
        input[type="file"]::file-selector-button {
            background-color: #FFD700; /* Gold */
            color: #1A237E; /* Deep Royal Blue */
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            font-weight: 500;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #e6c300; /* Darker Gold */
        }
        /* Stage Indicator Styling */
        .stage {
            border: 1px solid #ECEFF1; /* Silver border */
            transition: all 0.3s ease-in-out;
        }
        .stage.active {
            border-color: #FFD700; /* Gold border for active stage */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); /* Gold glow */
            transform: scale(1.02);
        }
        .stage.completed {
            border-color: #4CAF50; /* Green border for completed */
            background-color: rgba(76, 175, 80, 0.1); /* Subtle green background */
        }
        .stage.error {
           border-color: #F44336; /* Red border for error */
           background-color: rgba(244, 67, 54, 0.1); /* Subtle red background */
        }
        .stage-icon {
            width: 2rem; /* Fixed width for icons */
            height: 2rem; /* Fixed height for icons */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }
        /* Simple spinner for processing indication */
        .spinner {
            border: 4px solid rgba(236, 239, 241, 0.3); /* Light Silver border */
            border-left-color: #FFD700; /* Gold */
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Input field styling */
        input[type="text"].query-input {
            background-color: #283593; /* Slightly lighter blue */
            border: 1px solid #5C6BC0; /* Indigo border */
            color: #ECEFF1; /* Silver text */
            border-radius: 0.375rem; /* rounded-md */
        }
        input[type="text"].query-input::placeholder {
            color: #9FA8DA; /* Lighter indigo for placeholder */
        }
        input[type="text"].query-input:focus {
            outline: none;
            border-color: #FFD700; /* Gold border on focus */
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.3); /* Gold focus ring */
        }
        /* Ensure buttons maintain consistent height */
        .button-base {
            padding-top: 0.625rem; /* py-2.5 */
            padding-bottom: 0.625rem; /* py-2.5 */
            padding-left: 1.5rem; /* px-6 */
            padding-right: 1.5rem; /* px-6 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            text-align: center;
            line-height: 1.25rem; /* Ensure text vertical alignment */
            height: 2.75rem; /* Fixed height for consistency */
            display: inline-flex; /* Align items vertically */
            align-items: center; /* Center content vertically */
            justify-content: center; /* Center content horizontally */
        }
        .button-primary {
            background-color: #1A237E;
            color: white;
            border: 1px solid #FFD700; /* border-accent-gold */
        }
        .button-primary:hover:not(:disabled) { /* Only apply hover when not disabled */
            background-color: rgba(26, 35, 126, 0.8); /* hover:bg-opacity-80 */
        }
        .button-secondary {
             background-color: #FFD700; /* bg-accent-gold */
             color: #1A237E;
        }
         .button-secondary:hover:not(:disabled) { /* Only apply hover when not disabled */
             background-color: #e6c300; /* Darker gold */
         }
         .button-disabled {
             background-color: #455A64 !important; /* Use !important to override hover styles if needed */
             color: #90A4AE !important;
             cursor: not-allowed !important;
             border: 1px solid #78909C !important;
             opacity: 0.7; /* Add opacity for disabled state */
         }
         /* Style for displaying code */
         pre code {
            display: block;
            background: none;
            white-space: pre;
            -webkit-overflow-scrolling: touch;
            overflow-x: auto;
            max-width: 100%;
            min-width: 100px;
            padding: 0;
            background-color: #1e293b !important; /* Darker background for code */
            color: #e2e8f0 !important; /* Light text for code */
            border-radius: 0.25rem; /* rounded-sm */
            padding: 0.75rem; /* p-3 */
         }
         .whitespace-pre-wrap {
            white-space: pre-wrap; /* Wrap long lines */
            word-wrap: break-word; /* Break words if necessary */
         }

    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto">

        <header class="mb-8 p-4 bg-accent-gold rounded-lg shadow-md">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-[#1A237E]">Website.io - AI Council Forge</h1>
            <p class="text-center text-[#1A237E] mt-1">Forging Digital Excellence, One Command at a Time.</p>
        </header>

        <main class="space-y-8">

            <section class="bg-[#283593] p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2 accent-gold">1. Initiate Project</h2>
                <p class="mb-4 text-gray-300">Upload your project description (text, Markdown, or JSON). The AI Council's API workflow awaits your command.</p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="file" id="projectFile" class="block w-full text-sm text-gray-300
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-accent-gold file:text-[#1A237E]
                        hover:file:bg-yellow-600 cursor-pointer flex-grow
                        border border-gray-600 rounded-md p-2 h-[2.75rem]" accept=".txt,.md,.json">
                    <button id="initiateButton" class="button-base button-primary w-full sm:w-auto shadow-md">
                        Forge Website
                    </button>
                </div>
                <div id="uploadStatus" class="mt-4 text-sm text-gray-400"></div>
            </section>

            <section class="bg-[#283593] p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2 accent-gold">Query Council / System</h2>
                <p class="mb-4 text-gray-300">Ask a question about the process, status, or seek clarification.</p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <input type="text" id="queryInput" placeholder="Enter your question..." class="query-input flex-grow p-2.5 h-[2.75rem]">
                    <button id="submitQueryButton" class="button-base button-primary w-full sm:w-auto shadow-md">
                        Submit Query
                    </button>
                </div>
                <div id="queryResponseArea" class="mt-4 p-3 bg-[#1A237E] rounded border border-gray-600 min-h-[50px] text-gray-400 italic">
                    Awaiting query...
                </div>
            </section>

            <section class="bg-[#283593] p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-6 border-b border-gray-600 pb-2 accent-gold">2. Council Workflow Status</h2>
                 <p class="mb-4 text-sm text-gray-400">Monitoring API calls to the AI Council members. (Status updates upon completion)</p>
                <div class="space-y-4">
                    <div id="stage-1" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                        <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75c0-.231-.035-.454-.1-.664M6.75 7.5h10.5a2.25 2.25 0 012.25 2.25v7.5a2.25 2.25 0 01-2.25 2.25H6.75a2.25 2.25 0 01-2.25-2.25v-7.5a2.25 2.25 0 012.25-2.25z" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 1: Initial Draft</h3>
                            <p class="text-sm text-gray-300">Echo & Gemini: Structure, Layout, Early SEO</p>
                        </div>
                        <div class="status-indicator ml-4 flex-shrink-0"></div> </div>

                    <div id="stage-2" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                         <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 2: Optimization</h3>
                            <p class="text-sm text-gray-300">Mistral: Speed, Tailwind, Code Quality, Responsiveness</p>
                        </div>
                         <div class="status-indicator ml-4 flex-shrink-0"></div>
                    </div>

                    <div id="stage-3" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                         <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 001.5-.189m-1.5.189a6.01 6.01 0 01-1.5-.189m3.75 7.478a12.06 12.06 0 01-4.5 0m3.75 2.355a15.049 15.049 0 01-3.75 0M10.5 6.375c0-1.036.84-1.875 1.875-1.875h.375c1.036 0 1.875.84 1.875 1.875v1.875c0 1.036-.84 1.875-1.875 1.875h-.375C11.34 10.125 10.5 9.285 10.5 8.25v-1.875z" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 3: Deep Refinement</h3>
                            <p class="text-sm text-gray-300">Gemini: SEO, Core Web Vitals, Accessibility</p>
                        </div>
                         <div class="status-indicator ml-4 flex-shrink-0"></div>
                    </div>

                    <div id="stage-4" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                         <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 4: Strategic Rework</h3>
                            <p class="text-sm text-gray-300">Echo & Gemini: Structure, UX, Clarity, User Journey</p>
                        </div>
                         <div class="status-indicator ml-4 flex-shrink-0"></div>
                    </div>

                    <div id="stage-5" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                         <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 5: Language Polishing</h3>
                            <p class="text-sm text-gray-300">Claude: Natural Tone, Emotion, Flow</p>
                        </div>
                         <div class="status-indicator ml-4 flex-shrink-0"></div>
                    </div>

                    <div id="stage-6" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500">
                         <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-3-5.479m0 5.479a3 3 0 01-3 2.679m0-17.908a3 3 0 013-2.679m0 2.679a3 3 0 01-3 2.679m0 0a3 3 0 01-3-2.679m0 0c-.093.003-.187.005-.282.005a9.095 9.095 0 00-3.458-.474m2.679 17.908a9.095 9.095 0 01-3.458-.474m0 0a3 3 0 01-3-5.479m0 5.479a3 3 0 00-3 2.679m0-17.908c-.093.003-.187.005-.282.005a9.094 9.094 0 00-3.741-.479m5.479 17.908a3 3 0 01-5.479 0m5.479 0a3 3 0 013-2.679m0 0c.093-.003.187-.005.282-.005a9.095 9.095 0 013.458.474m-2.679-17.908a9.095 9.095 0 003.458.474m0 0a3 3 0 003-2.679m-3 2.679a3 3 0 013-2.679" /></svg>
                        </div>
                        <div class="flex-grow">
                            <h3 class="font-semibold text-lg">Stage 6: Final Council Review</h3>
                            <p class="text-sm text-gray-300">All AIs: Collective Refinement, Final Wisdom</p>
                        </div>
                         <div class="status-indicator ml-4 flex-shrink-0"></div>
                    </div>
                </div>
            </section>

            <section class="bg-[#283593] p-6 rounded-lg shadow-lg border border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 border-b border-gray-600 pb-2 accent-gold">3. Founder's Review & Output</h2>
                <p class="mb-4 text-gray-300">Once the Council completes its work via backend APIs, review the final artifact here.</p>
                <div id="outputArea" class="p-4 bg-[#1A237E] rounded border border-gray-600 min-h-[100px] mb-4 text-gray-400 italic">
                    Awaiting Council completion...
                </div>
                 <div id="stage-7" class="stage flex items-center p-4 rounded-md bg-opacity-10 bg-gray-500 mb-4">
                     <div class="stage-icon mr-4 text-gray-400"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <div class="flex-grow">
                        <h3 class="font-semibold text-lg">Stage 7: Founder Approval</h3>
                        <p class="text-sm text-gray-300">Cannon: Final Review, Edit, Approve</p>
                    </div>
                     <div class="status-indicator ml-4 flex-shrink-0"></div>
                </div>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <button id="previewButton" class="button-base button-disabled w-full sm:w-auto shadow-md" disabled>
                        Preview Website
                    </button>
                    <button id="downloadButton" class="button-base button-disabled w-full sm:w-auto shadow-md" disabled>
                        Download Files
                    </button>
                     <button id="publishButton" class="button-base button-disabled w-full sm:w-auto shadow-md" disabled>
                        Approve & Publish
                    </button>
                </div>
            </section>
        </main>

        <footer class="mt-12 text-center text-sm text-gray-400">
            <p>&copy; <span id="currentYear"></span> Website.io - Forged by the AI Council under the command of Cannon.</p>
            <p class="accent-gold font-semibold">Loyalty. Excellence. Creativity.</p>
        </footer>
    </div>

    <script>
        // Set current year in footer
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- Configuration ---
        // Set the base URL for your backend server
        const BACKEND_URL = 'http://localhost:3000'; // Adjust if your backend runs elsewhere

        // --- DOM Element References ---
        const initiateButton = document.getElementById('initiateButton');
        const projectFile = document.getElementById('projectFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const stages = document.querySelectorAll('.stage');
        const outputArea = document.getElementById('outputArea');
        const previewButton = document.getElementById('previewButton');
        const downloadButton = document.getElementById('downloadButton');
        const publishButton = document.getElementById('publishButton');
        const queryInput = document.getElementById('queryInput');
        const submitQueryButton = document.getElementById('submitQueryButton');
        const queryResponseArea = document.getElementById('queryResponseArea');

        // --- Helper Functions ---

        // Updates the visual status of a workflow stage
        function updateStageStatus(stageId, status, message = '') {
            const stageElement = document.getElementById(stageId);
            if (!stageElement) return;
            const indicator = stageElement.querySelector('.status-indicator');
            if (!indicator) return;

            stageElement.classList.remove('active', 'completed', 'pending', 'error');
            indicator.innerHTML = ''; // Clear previous indicator

            switch (status) {
                case 'pending':
                    stageElement.classList.add('pending');
                    indicator.innerHTML = `<span class="text-xs text-gray-400">Pending</span>`;
                    break;
                case 'active': // Represents the entire backend process running
                    stageElement.classList.add('active');
                    indicator.innerHTML = `<div class="spinner" role="status"><span class="sr-only">Processing...</span></div>`;
                    break;
                case 'completed':
                    stageElement.classList.add('completed');
                    indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                    break;
                case 'error':
                     stageElement.classList.add('error');
                     indicator.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                    break;
                default: // Idle state
                     indicator.innerHTML = `<span class="text-xs text-gray-500">-</span>`;
            }
        }

        // Enables or disables the final action buttons
        function setActionButtonsState(enabled) {
            const buttons = [previewButton, downloadButton, publishButton];
            buttons.forEach(button => {
                button.disabled = !enabled;
                // Clear potentially conflicting classes first
                button.classList.remove('button-primary', 'button-secondary', 'button-disabled');
                if (enabled) {
                    button.classList.remove('opacity-70'); // Ensure full opacity when enabled
                    if (button.id === 'publishButton') {
                        button.classList.add('button-secondary'); // Gold button
                    } else {
                        button.classList.add('button-primary'); // Standard blue button
                    }
                } else {
                    button.classList.add('button-disabled'); // Disabled style
                }
            });
        }

        // Helper function to safely display HTML content as text/code
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') {
                console.warn("escapeHtml received non-string input:", unsafe);
                return ''; // Return empty string for non-string inputs
            }
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
         }

        // --- Backend Interaction Logic ---
        function triggerForgeWorkflow() {
            if (projectFile.files.length === 0) {
                uploadStatus.textContent = 'Please select a project file first.';
                uploadStatus.classList.add('text-red-400');
                return;
            }
            uploadStatus.classList.remove('text-red-400');
            uploadStatus.textContent = 'Uploading file and initiating Council workflow...';

            // Disable initiate button during processing
            initiateButton.disabled = true;
            initiateButton.classList.add('button-disabled'); // Add disabled style

            // Reset UI states for workflow section
            stages.forEach(stage => updateStageStatus(stage.id, 'pending'));
            outputArea.innerHTML = '<em class="text-gray-400">Council workflow initiated...</em>';
            setActionButtonsState(false); // Ensure action buttons are disabled

            // Set initial stages to active (representing backend work)
            updateStageStatus('stage-1', 'active'); // Show spinner on first stage

            // Prepare form data
            const formData = new FormData();
            formData.append('projectFile', projectFile.files[0]); // Key must match backend 'projectFile'

            // Make the API call to the backend
            fetch(`${BACKEND_URL}/forge`, {
                method: 'POST',
                body: formData,
                // Headers like 'Content-Type': 'multipart/form-data' are typically set automatically by the browser for FormData
            })
            .then(async response => { // Make the callback async to use await for response.json()
                const isJson = response.headers.get('content-type')?.includes('application/json');
                const data = isJson ? await response.json() : null;

                // Check for HTTP errors
                if (!response.ok) {
                    // Get error message from JSON body or default to status text
                    const error = (data && data.error) || response.statusText || `HTTP error ${response.status}`;
                    return Promise.reject(new Error(error)); // Reject the promise to trigger .catch()
                }
                return data; // Pass the parsed JSON data to the next .then()
            })
            .then(data => {
                if (data && data.success) {
                    console.log("Workflow successful. Final draft received.");
                    uploadStatus.textContent = 'AI Council workflow completed successfully!';
                    uploadStatus.classList.remove('text-red-400'); // Ensure no error color

                    // Display the final draft safely escaped within <pre><code> tags
                    outputArea.innerHTML = `<h4 class="text-green-300 font-semibold mb-2">Final Website Draft:</h4><pre class="whitespace-pre-wrap"><code>${escapeHtml(data.finalWebsiteDraft)}</code></pre>`;

                    // Mark all council stages as completed
                    for (let i = 1; i <= 6; i++) {
                        updateStageStatus(`stage-${i}`, 'completed');
                    }
                    // Set Founder review stage as ready (active/pending action)
                    updateStageStatus('stage-7', 'active'); // Or 'pending' if preferred visual
                    setActionButtonsState(true); // Enable Preview, Download, Publish buttons

                } else {
                    // Handle cases where response is OK but success: false (unexpected)
                    throw new Error(data?.error || 'Backend reported failure without specific error message.');
                }
            })
            .catch(error => {
                console.error('Error during forge workflow:', error);
                uploadStatus.textContent = `Error: ${error.message}`;
                uploadStatus.classList.add('text-red-400');
                outputArea.innerHTML = `<em class="text-red-400">Workflow failed: ${error.message}</em>`;

                // Indicate error state visually (e.g., mark first stage as error)
                updateStageStatus('stage-1', 'error'); // Or find the relevant stage if backend provides it
                // Ensure later stages are not marked active/completed
                 for (let i = 2; i <= 7; i++) {
                        updateStageStatus(`stage-${i}`, 'idle'); // Reset later stages
                 }
                 setActionButtonsState(false); // Keep action buttons disabled on error
            })
            .finally(() => {
                // Re-enable initiate button regardless of success/failure
                initiateButton.disabled = false;
                initiateButton.classList.remove('button-disabled');
            });
        }


        // --- Event Listeners ---

        // Initiate Workflow Button
        initiateButton.addEventListener('click', triggerForgeWorkflow);

        // File Selection Change
         projectFile.addEventListener('change', () => {
            if (projectFile.files.length > 0) {
                uploadStatus.textContent = `Selected: ${projectFile.files[0].name}`;
                uploadStatus.classList.remove('text-red-400');
            } else {
                 uploadStatus.textContent = '';
            }
         });

        // Submit Query Button (Placeholder Logic)
        submitQueryButton.addEventListener('click', () => {
            const query = queryInput.value.trim();
            if (!query) {
                queryResponseArea.innerHTML = '<em class="text-yellow-400">Please enter a question.</em>';
                return;
            }
            queryResponseArea.innerHTML = `<em class="text-gray-400">Processing query: "${query}"... (Demo only)</em>`;
            setTimeout(() => {
                 queryResponseArea.innerHTML = `<p class="text-gray-200"><strong>Query:</strong> ${query}</p>
                                                <p class="text-cyan-300 mt-2"><strong>Response:</strong> (Placeholder) This query would be sent to the backend for processing in a full implementation.</p>`;
                 // queryInput.value = ''; // Optionally clear input
            }, 1000);
        });

         // Action Buttons (Preview, Download, Publish) - Placeholders
         previewButton.addEventListener('click', () => {
             if(previewButton.disabled) return;
             // In a real app, you might take the content from outputArea, unescape it,
             // create a Blob, and open it in a new tab.
             alert('Preview functionality: This would render the generated HTML. (Not implemented in demo)');
         });
         downloadButton.addEventListener('click', () => {
              if(downloadButton.disabled) return;
              // In a real app, take the content from outputArea, create a Blob,
              // and trigger a download link.
             alert('Download functionality: This would save the generated HTML file. (Not implemented in demo)');
         });
         publishButton.addEventListener('click', () => {
             if(publishButton.disabled) return;
             alert('Publish action triggered! (Not implemented in demo)');
             uploadStatus.textContent = 'Project Approved and Published by the Founder!';
             publishButton.textContent = 'Published';
             setActionButtonsState(false); // Disable all action buttons after publish
             publishButton.disabled = true; // Ensure publish stays disabled
             publishButton.classList.add('button-disabled'); // Add specific disabled style
         });


        // --- Initial Page Load Setup ---
        function initializeUI() {
             stages.forEach(stage => updateStageStatus(stage.id, 'idle'));
             setActionButtonsState(false);
             uploadStatus.textContent = '';
             queryResponseArea.innerHTML = '<em class="text-gray-400">Awaiting query...</em>';
        }

        document.addEventListener('DOMContentLoaded', initializeUI);

    </script>
</body>
</html>
